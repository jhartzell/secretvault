_Auto-generated by Supermemory (genesis). Last updated: 2026-02-21_

### Go CLI with Clean Architecture Layers
secretvault is a Go CLI tool for encrypting/decrypting sensitive project files using AES-256-GCM. Three-layer architecture: `cmd/secretvault/` (thin CLI wrappers), `internal/application/` (command orchestration), `internal/domain/` (core logic), `internal/integrations/` (external systems).
<!-- session:genesis | files:cmd/secretvault/main.go,internal/application/,internal/domain/,internal/integrations/ | area:architecture | date:2026-02-21 -->

### Tech Stack: Go 1.22, go-keyring, 1Password CLI
Go 1.22 with go-task runner. Dependencies: `zalando/go-keyring` for OS keychain storage, `golang.org/x/term` for terminal interaction. Optional runtime dependency on 1Password CLI (`op`) for absorb/restore workflows.
<!-- session:genesis | files:go.mod,Taskfile.yml | area:architecture | date:2026-02-21 -->

### CLI Entrypoint is a Thin Delegation Layer
`cmd/secretvault/main.go` routes commands to `internal/application` functions. All `cmd/secretvault/*.go` files are thin wrappers that re-export domain/integration types and functions — they add no business logic. This is intentional per AGENTS.md guidelines.
<!-- session:genesis | files:cmd/secretvault/main.go,cmd/secretvault/commands_runtime.go,cmd/secretvault/commands_locking.go | area:architecture | date:2026-02-21 -->

### Encryption Format: SVAULT01 Magic Header + AES-256-GCM
Encrypted files use `.svault` extension. Payload format: `SVAULT01` magic header (8 bytes) + GCM nonce (12 bytes) + file permissions (4 bytes big-endian uint32) + AES-256-GCM ciphertext. File permissions are preserved through encrypt/decrypt cycles.
<!-- session:genesis | files:internal/domain/crypto.go | area:architecture | date:2026-02-21 -->

### Atomic File Writes via Temp + Rename
All file writes use `WriteAtomic()` which creates a temp file in the same directory, writes content, sets permissions, then atomically renames. This prevents partial writes corrupting files.
<!-- session:genesis | files:internal/domain/crypto.go | area:patterns | date:2026-02-21 -->

### Project Identity is SHA256 of CWD
`ProjectContext` derives `ProjectID` from SHA256 of the absolute working directory path (first 8 bytes hex-encoded). This ID is used for keyring storage key (`project-<id>`) and vault directory path (`~/.secretvault/projects/<id>/`).
<!-- session:genesis | files:internal/domain/domain.go | area:architecture | date:2026-02-21 -->

### Vault Manifest Tracks All Locked Files
`~/.secretvault/projects/<project-id>/manifest.json` stores a JSON manifest with version, project metadata, and entries keyed by absolute path. Each entry tracks file ID, paths, lock timestamps, original permissions, and optional 1Password metadata.
<!-- session:genesis | files:internal/domain/vault_store.go | area:architecture | date:2026-02-21 -->

### Three-Tier Restore Source Resolution
`ResolveLocalRestoreSource` checks three locations in order: (1) `<target>.svault` in project, (2) `entry.ProjectEncryptedFile`, (3) vault backup in `~/.secretvault/`. Falls back to 1Password document download if no local source found.
<!-- session:genesis | files:internal/domain/vault_store.go,internal/application/commands_runtime.go | area:patterns | date:2026-02-21 -->

### Sensitive File Discovery: Names, Suffixes, Dirs, Content
Files are detected as sensitive by: exact name match (`.env`, `terraform.tfvars`, etc.), suffix match (`.tfvars`, `.pem`, `.key`, etc.), parent directory name (`secrets/`, `.aws/`, `.ssh/`), or content pattern regex matching secret-like patterns in first 4KB. Files >1MB skip content scanning.
<!-- session:genesis | files:internal/domain/discovery.go,internal/domain/domain.go | area:architecture | date:2026-02-21 -->

### Ignored Directories During Discovery
File discovery skips `.git`, `.svn`, `.hg`, `node_modules`, `dist`, `build`, `vendor`, `.next`, `.nuxt`, `.idea`, `.vscode`, `.ai-sessions`. Both sensitive and encrypted file scans respect this list.
<!-- session:genesis | files:internal/domain/domain.go | area:conventions | date:2026-02-21 -->

### Key Storage via OS Keyring
Encryption keys are 32-byte AES-256 keys stored in the OS keyring via `go-keyring`. Keys are either randomly generated (`--generate`) or derived from passphrases via SHA256. Stored as base64 in keyring under service `secrets-vault-cli` with key ID `project-<project-id>`.
<!-- session:genesis | files:internal/integrations/keyringstore/keyring.go | area:architecture | date:2026-02-21 -->

### Hook Installer for Claude and OpenCode
`install` command creates pre-message and post-response shell hook scripts. Two modes: `stable-dev` (both hooks run `lock`, keeping vault shielded during LLM turns) and `strict` (pre=lock, post=unlock). Scripts are best-effort with `|| true`.
<!-- session:genesis | files:internal/integrations/hooks/hooks.go,internal/application/commands_runtime.go | area:architecture | date:2026-02-21 -->

### Run Command: Temporary Secret Exposure
`secretvault run -- <cmd>` restores secrets, executes the wrapped command with `SECRETVAULT_RUNTIME=1` env var, then re-locks regardless of command success. Both command error and re-lock error are reported if both fail.
<!-- session:genesis | files:internal/application/commands_runtime.go | area:patterns | date:2026-02-21 -->

### Absorb Workflow: Lock + 1Password Upload
`absorb` discovers sensitive files, uploads each to 1Password as a document, encrypts locally, tracks in vault manifest with 1Password metadata (vault name, document ID, title, SHA256 checksum). Requires `op` CLI authenticated.
<!-- session:genesis | files:internal/application/commands_absorb_setup.go | area:architecture | date:2026-02-21 -->

### Tests Use Real Filesystem, Not Mocks
Test suite in `cmd/secretvault/main_test.go` uses `t.TempDir()`, environment variable manipulation (`withEnv`), and working directory changes (`withChdir`). No mocking of crypto or filesystem — tests exercise real encryption/decryption round-trips.
<!-- session:genesis | files:cmd/secretvault/main_test.go | area:conventions | date:2026-02-21 -->

### Task Runner Commands
`task build` builds to `bin/secretvault`, `task test` runs `go test ./...`, `task smoke` runs `smoke-test.sh` end-to-end, `task release VERSION=vX.Y.Z` tags and pushes. `task dev` just runs `help`.
<!-- session:genesis | files:Taskfile.yml | area:conventions | date:2026-02-21 -->

### CI: Tests + Smoke on Ubuntu
GitHub Actions CI runs on all branches/PRs. Steps: checkout, setup Go (version from go.mod), setup Task, run `task test`, run `task smoke`. Release workflow triggers on `v*` tags using `softprops/action-gh-release`.
<!-- session:genesis | files:.github/workflows/ci.yml,.github/workflows/release.yml | area:conventions | date:2026-02-21 -->

### SECRETVAULT_HOME Override for Vault Location
Vault home defaults to `~/.secretvault/` but can be overridden via `SECRETVAULT_HOME` env var. Tests use this to isolate vault state. Similarly, `SECRETVAULT_OP_VAULT` sets the default 1Password vault name for absorb.
<!-- session:genesis | files:internal/domain/vault_paths.go,internal/application/commands_absorb_setup.go | area:conventions | date:2026-02-21 -->

### Vault Backup Path Uses Content-Addressable Layout
Vault backups are stored at `~/.secretvault/projects/<project-id>/files/<first-2-hex>/<full-sha256>.svault`. The file ID is SHA256 of the absolute original path, creating a content-addressable-style directory structure.
<!-- session:genesis | files:internal/domain/vault_store.go | area:patterns | date:2026-02-21 -->

### Duplicate HasCommand Function
`HasCommand()` is defined in both `internal/integrations/system/system.go` and `internal/integrations/opcli/opcli.go`. The opcli version is used internally for `op` checks within that package. This is minor duplication.
<!-- session:genesis | files:internal/integrations/system/system.go,internal/integrations/opcli/opcli.go | area:gotchas | date:2026-02-21 -->

### cmd/ Files Re-export Domain Functions
Most `cmd/secretvault/*.go` files (crypto.go, discovery.go, vault_store.go, etc.) are pure re-exports of `internal/domain` functions. This creates a facade but also duplicates function signatures extensively. The test file in cmd/ tests through these wrappers.
<!-- session:genesis | files:cmd/secretvault/crypto.go,cmd/secretvault/discovery.go,cmd/secretvault/vault_store.go | area:gotchas | date:2026-02-21 -->

### discovery.go in cmd/ Has Duplicated Logic
`cmd/secretvault/discovery.go` contains `hasSensitiveDir()` and `looksSensitiveByContent()` implementations that duplicate the same functions in `internal/domain/discovery.go`. These cmd-level copies appear unused since all command logic delegates to `internal/application`.
<!-- session:genesis | files:cmd/secretvault/discovery.go,internal/domain/discovery.go | area:gotchas | date:2026-02-21 -->

### Setup Command: Interactive Dependency Wizard
`secretvault setup` checks for `op` CLI, suggests platform-specific install commands (brew, apt-get, dnf, pacman, zypper, winget), can auto-install, and handles `op signin` interactively. Uses terminal detection to auto-confirm in non-interactive mode.
<!-- session:genesis | files:internal/application/commands_absorb_setup.go | area:architecture | date:2026-02-21 -->

### Smoke Test Covers Full Lifecycle
`smoke-test.sh` builds the binary, creates a temp project with `.env`/`.tfvars`/secrets, tests scan/lock/run-wrapper/restore-from-backup/hook-install/unlock, and verifies SHA256 round-trip integrity. This is the primary integration test.
<!-- session:genesis | files:smoke-test.sh | area:conventions | date:2026-02-21 -->

### SelectRestoreEntries Supports Multiple Match Strategies
Restore entry selection matches by: absolute path, relative path, or filename basename. Supports `--all` flag for all entries, defaults to missing-only, and deduplicates when multiple args resolve to the same entry.
<!-- session:genesis | files:internal/domain/vault_store.go | area:patterns | date:2026-02-21 -->

### No Logging Framework Used
The codebase uses `fmt.Printf`/`fmt.Println` for all output. No structured logging, no log levels. Error output goes to stderr only via `exitWithError` in main.
<!-- session:genesis | files:cmd/secretvault/config.go,internal/application/ | area:conventions | date:2026-02-21 -->

### - **1Password CLI v2 signin**: `op signin` does not accept address as positional arg; use `op --account <address> signin` instead
- **1Password Secret Key requirement**: Manual `op account add` requires Secret Key (not just u/p); desktop app integration via Developer settings avoids this friction
- **Arch Linux AUR packages**: `1password-cli` and `1password` are AUR-only on Arch; must use `yay`/`paru` instead of `pacman`
- **Shell compatibility on Arch**: `yay`/`paru` builds use bash features (`compgen`); running via `sh -c` fails, must use `bash -lc`
<!-- session:2026-02-21-ff9dfe3f | commit:530ce77ee5d1508113638cf3d1b8edfb824803e2 | files:`internal/integrations/system/system.go`,`internal/application/commands_absorb_setup.go` | area:`internal | date:2026-02-21 -->
